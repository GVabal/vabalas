services:
  backend:
    depends_on:
      - kibana
      - postgres
    restart: always
    image: backend:latest
    build: ./backend
    deploy:
      mode: replicated
      replicas: 1
    ports:
      - "8000:8000"
    environment:
      SPRING_PROFILES_ACTIVE: "prod"
      PORT: "8000"

  caddy:
    depends_on:
      - backend
    restart: always
    image: caddy/caddy:latest
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    ports:
      - "80:80"
      - "443:443"

  cadvisor:
    restart: always
    image: gcr.io/cadvisor/cadvisor:latest
    platform: linux/amd64/v3
    deploy:
      mode: replicated
      replicas: 1
    volumes:
    - type: bind
      source: /
      target: /rootfs
      read_only: true
      bind:
        propagation: rslave
    - type: bind
      source: /var/lib/docker/
      target: /var/lib/docker
      read_only: true
      bind:
        propagation: rslave
    - type: bind
      source: /var/run
      target: /var/run
      read_only: true
      bind:
        propagation: rslave
    - type: bind
      source: /sys
      target: /sys
      read_only: true
      bind:
        propagation: rslave
    - type: bind
      source: /dev/disk/
      target: /dev/disk
      read_only: true
      bind:
        propagation: rslave
    ports:
      - "8080:8080"

  elasticsearch:
    restart: always
    image: docker.elastic.co/elasticsearch/elasticsearch:8.16.0
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '1'
          memory: 1024m
    ports:
      - "9200:9200"
    environment:
      - "discovery.type=single-node"
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-search}

  logstash:
    depends_on:
      - elasticsearch
    restart: always
    image: docker.elastic.co/logstash/logstash:8.16.0
    deploy:
      resources:
        limits:
          memory: 512m
    user: root
    volumes:
      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf:ro
    ports:
      - "5044:5044/udp"
    environment:
      LS_JAVA_OPTS: "-Xmx256m -Xms256m"
      ELASTIC_USER: elastic
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD:-search}
      ELASTIC_HOSTS: http://elasticsearch:9200
    command: logstash -f /usr/share/logstash/pipeline/logstash.conf

  kibana:
    depends_on:
      - logstash
      - elasticsearch
    restart: always
    image: docker.elastic.co/kibana/kibana:8.16.0
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
      ELASTICSEARCH_USERNAME: kibana_system
      ELASTICSEARCH_PASSWORD: ${KIBANA_PASSWORD:-banana}

  postgres:
    restart: always
    image: postgres:17
    environment:
      POSTGRES_DB: pgdb
      POSTGRES_USER: ${DB_USER:-sa}
      POSTGRES_PASSWORD: ${DB_PASS:-changeme}
    volumes:
      - pg_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

volumes:
  caddy_data:
  caddy_config:
  pg_data:
